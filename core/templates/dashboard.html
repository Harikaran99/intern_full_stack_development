{% extends "base.html" %} {% block content %}
<style>
  /* ‚îÄ‚îÄ Page layout ‚îÄ‚îÄ */
  html,
  body {
    height: 100%;
    margin: 0;
    overflow: hidden;
  }

  body {
    background-color: #22252a;
    color: #ffffff;
    font-family: "Poppins", "Segoe UI", sans-serif;
    transform: none;
    width: 100%;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Chat wrapper (below fixed navbar) ‚îÄ‚îÄ */
  .chat-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 80px);
    margin-top: 80px;
    position: relative;
  }

  /* ‚îÄ‚îÄ Scrollable message area ‚îÄ‚îÄ */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 32px 8% 120px 8%;
    display: flex;
    flex-direction: column;
    gap: 28px;
    scroll-behavior: smooth;
  }

  .chat-messages::-webkit-scrollbar {
    width: 5px;
  }
  .chat-messages::-webkit-scrollbar-track {
    background: transparent;
  }
  .chat-messages::-webkit-scrollbar-thumb {
    background: #3a4450;
    border-radius: 10px;
  }

  /* ‚îÄ‚îÄ Empty / welcome state ‚îÄ‚îÄ */
  .welcome-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 10px;
    text-align: center;
    padding-bottom: 80px;
    animation: fadeUp 0.6s ease;
  }

  .welcome-state .robot-avatar {
    width: 110px;
    height: 110px;
    object-fit: contain;
    margin-bottom: 8px;
    filter: drop-shadow(0 0 18px rgba(100, 180, 210, 0.18));
  }

  .welcome-name {
    font-family: "Overlock SC", cursive;
    font-size: 28px;
    color: #d97a4e;
    margin: 0;
    letter-spacing: 0.5px;
  }

  .welcome-sub {
    font-size: 17px;
    color: #c8d4dd;
    margin: 2px 0 10px 0;
  }

  .welcome-quote {
    font-style: italic;
    font-size: 14px;
    color: #5a7080;
    max-width: 560px;
    line-height: 1.6;
    margin: 0;
  }

  /* ‚îÄ‚îÄ Message row ‚îÄ‚îÄ */
  .msg-row {
    display: flex;
    flex-direction: column;
    animation: fadeUp 0.3s ease;
  }

  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .msg-row.user {
    align-items: flex-end;
  }
  .msg-row.bot {
    align-items: flex-start;
  }

  /* user bubble */
  .msg-bubble {
    background-color: #2e3840;
    color: #d4dde5;
    padding: 10px 18px;
    border-radius: 22px;
    max-width: 60%;
    font-size: 15px;
    line-height: 1.6;
    word-wrap: break-word;
  }

  /* bot: no bubble */
  .msg-row.bot .msg-bubble {
    background: transparent;
    color: #c9d3dc;
    padding: 0;
    border-radius: 0;
    max-width: 90%;
    font-size: 15px;
    line-height: 1.8;
  }

  .msg-row.bot .msg-bubble p {
    margin: 4px 0;
  }
  .msg-row.bot .msg-bubble ul {
    padding-left: 1.3rem;
    margin: 4px 0;
  }
  .msg-row.bot .msg-bubble li {
    margin-bottom: 2px;
  }

  /* typing indicator dots */
  .typing-indicator {
    display: flex;
    gap: 5px;
    align-items: center;
    padding: 6px 0;
  }

  .typing-indicator span {
    width: 8px;
    height: 8px;
    background: #5a7a8a;
    border-radius: 50%;
    animation: bounce 1.2s infinite;
  }

  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }
  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%,
    80%,
    100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1.2);
      opacity: 1;
    }
  }

  /* ‚îÄ‚îÄ Fixed bottom input bar ‚îÄ‚îÄ */
  .chat-input-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 14px 18%;
    background-color: #22252a;
    border-top: 1px solid #2a3340;
    z-index: 100;
  }

  .chat-input-form {
    display: flex;
    align-items: center;
    background-color: #2b333b;
    border-radius: 30px;
    padding: 10px 18px;
    gap: 12px;
    border: 1px solid #3a4450;
    transition: border-color 0.3s;
  }

  .chat-input-form:focus-within {
    border-color: #5a7a8a;
  }

  .input-icon-svg {
    opacity: 0.45;
    flex-shrink: 0;
    margin-right: 6px;
  }

  .chat-input-field {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #c8d4dd;
    font-family: "Poppins", sans-serif;
    font-size: 15px;
    padding-left: 4px;
  }

  .chat-input-field {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #c8d4dd;
    font-family: "Poppins", sans-serif;
    font-size: 15px;
  }

  .chat-input-field::placeholder {
    color: #566470;
  }

  .send-btn {
    background-color: #3a4f5a;
    border: none;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition:
      background 0.25s,
      transform 0.15s;
    flex-shrink: 0;
    padding: 0;
  }

  .send-btn:hover {
    background-color: #4e6d7c;
    transform: scale(1.08);
  }
  .send-btn:disabled {
    opacity: 0.4;
    cursor: default;
    transform: none;
  }
  .send-btn svg {
    fill: #aac8d8;
  }

  .send-btn .spin {
    width: 16px;
    height: 16px;
    border: 2px solid #aac8d8;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* error toast */
  .toast-error {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: #8b2020;
    color: #ffd5d5;
    padding: 10px 22px;
    border-radius: 24px;
    font-size: 14px;
    z-index: 999;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }

  .toast-error.show {
    opacity: 1;
  }
</style>

<!-- Error toast -->
<div class="toast-error" id="errorToast"></div>

<div class="chat-page">
  <!-- Scrollable messages -->
  <div class="chat-messages" id="chatMessages">
    {% if entries %} {% for entry in entries reversed %}
    <div class="msg-row user">
      <div class="msg-bubble">{{ entry.question_text }}</div>
    </div>
    <div class="msg-row bot">
      <div class="msg-bubble">{{ entry.answer_text|linebreaks }}</div>
    </div>
    {% endfor %} {% else %}
    <!-- Welcome / empty state -->
    <div class="welcome-state" id="welcomeState">
      {% load static %}
      <img
        src="{% static 'assets/robot.png' %}"
        alt="Clara"
        class="robot-avatar"
      />
      <p class="welcome-name">
        Welcome Back,&nbsp; Mr {{ request.user.username }} üåü
      </p>
      <p class="welcome-sub">ü§ñ My Name is Clara from AskVoltieAI Corp</p>
      <p class="welcome-quote">
        "Am an Experienced AI model for handling<br />Electrical machines
        Related Question"
      </p>
    </div>
    {% endif %}
  </div>

  <!-- Fixed bottom input -->
  <div class="chat-input-bar">
    <div class="chat-input-form" id="chatInputWrapper">
      <!-- keyboard icon -->
      <svg
        class="input-icon-svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="#6b8899"
        stroke-width="1.8"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect x="2" y="4" width="20" height="16" rx="3" />
        <path
          d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h4M18 12h.01M8 16h8"
        />
      </svg>

      <input
        type="text"
        id="questionInput"
        class="chat-input-field"
        placeholder="Ask about electrical machines..."
        autocomplete="off"
      />

      <button
        type="button"
        class="send-btn"
        id="sendBtn"
        onclick="sendMessage()"
      >
        <svg id="sendIcon" width="18" height="18" viewBox="0 0 24 24">
          <path d="M2 21L23 12 2 3v7l15 2-15 2v7z" />
        </svg>
        <div id="sendSpinner" class="spin" style="display: none"></div>
      </button>
    </div>
  </div>
</div>

<script>
  const chatMessages = document.getElementById("chatMessages");
  const questionInput = document.getElementById("questionInput");
  const sendBtn = document.getElementById("sendBtn");
  const sendIcon = document.getElementById("sendIcon");
  const sendSpinner = document.getElementById("sendSpinner");
  const welcomeState = document.getElementById("welcomeState");
  const errorToast = document.getElementById("errorToast");

  // Scroll to bottom on load
  window.addEventListener("load", () => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  // Send on Enter key
  questionInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function setLoading(loading) {
    sendBtn.disabled = loading;
    sendIcon.style.display = loading ? "none" : "block";
    sendSpinner.style.display = loading ? "block" : "none";
    questionInput.disabled = loading;
  }

  function showError(msg) {
    errorToast.textContent = msg;
    errorToast.classList.add("show");
    setTimeout(() => errorToast.classList.remove("show"), 3500);
  }

  function appendUserBubble(text) {
    const row = document.createElement("div");
    row.className = "msg-row user";
    row.innerHTML = `<div class="msg-bubble">${escapeHtml(text)}</div>`;
    chatMessages.appendChild(row);
    scrollBottom();
    return row;
  }

  function appendTypingIndicator() {
    const row = document.createElement("div");
    row.className = "msg-row bot";
    row.id = "typingRow";
    row.innerHTML = `<div class="msg-bubble">
      <div class="typing-indicator">
        <span></span><span></span><span></span>
      </div>
    </div>`;
    chatMessages.appendChild(row);
    scrollBottom();
    return row;
  }

  function replaceTypingWithAnswer(text) {
    const typingRow = document.getElementById("typingRow");
    if (typingRow) {
      // Convert newlines to <br> (simple formatting)
      const formatted = escapeHtml(text).replace(/\n/g, "<br>");
      typingRow.removeAttribute("id");
      typingRow.querySelector(".msg-bubble").innerHTML = formatted;
      scrollBottom();
    }
  }

  function scrollBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function escapeHtml(text) {
    const d = document.createElement("div");
    d.appendChild(document.createTextNode(text));
    return d.innerHTML;
  }

  function getCsrfToken() {
    const cookie = document.cookie
      .split(";")
      .find((c) => c.trim().startsWith("csrftoken="));
    return cookie ? cookie.trim().split("=")[1] : "";
  }

  async function sendMessage() {
    const question = questionInput.value.trim();
    if (!question) return;

    // Hide welcome state on first message
    if (welcomeState) welcomeState.style.display = "none";

    questionInput.value = "";
    setLoading(true);

    // Immediately show user bubble
    appendUserBubble(question);
    // Show typing indicator
    appendTypingIndicator();

    try {
      const response = await fetch("/ask/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrfToken(),
        },
        body: `question_text=${encodeURIComponent(question)}`,
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || `Server error ${response.status}`);
      }

      const data = await response.json();
      replaceTypingWithAnswer(data.answer);
    } catch (err) {
      // Remove typing indicator on error
      const typingRow = document.getElementById("typingRow");
      if (typingRow) typingRow.remove();
      showError("‚ö†Ô∏è " + err.message);
      console.error(err);
    } finally {
      setLoading(false);
      questionInput.focus();
    }
  }
</script>
{% endblock %}
